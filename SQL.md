# SQLを書くときに守ること<br>（正確無比なクエリに近道なし！！！）
BigQuery(標準SQL)で、定期更新するモニタリング用データマートを設計するとき、実装するときに気をつけたいこと

## ■ 前提は疑う（最初に確認すること）
- テーブル定義書（主キー、保有する項目）が正しいか
- テーブルのレコード数
- 事業データベースとの同期頻度と更新時刻
- 加工・集計されていないか（極力使用しないこと）
- レコードをパージする仕様がないか
- 事業サイドやエンジニアからヒアリングした情報は正しいか
- 手作成されたファイルの中身は妥当そうか

## ■ 自信を持たない、過信しない
- 作業は１ステップごとに想定どおりを確認
- 集計を複数伴う場合は一気に書かない
- サブクエリ単位で、検証した値を継承しながら組み立てる
- 既存のクエリではどう扱っているかも確認する
- 日を跨いだ検証も忘れずに

## ■ SELECT
- 文字列の'NULL'や''はNULLに変換
- 集計を伴わない AS 別名(ALIAS) は最下位のサブクエリで
- 四則演算, GREATEST, LEASTはNULL値に注意（IFNULL,COALESCEを活用）
- フラグ項目は必ず1,0に（NULLを混在させない）
- 汎用的なカテゴライズロジックはマスタ化しよう
- 定番のサブクエリはVIEWにしよう
- タイムゾーンに注意（CURRENT_DATE('Asia/Tokyo')）
- パーティション日付はあえて出力する（前日当日に気をつける）
- コードと名称がある場合は、コード値を出力すべきか検討（BIツールで後からマッピング）
- UNION ALLするときは、並び順を丁寧に

## ■ WHERE
- データ型に注意
- AND, OR, (), !=, <=, >=, NOT はベン図を描く
- DATE_ADDで日付比較する場合、期間はしっかり定義する
- バックアップ時の隠れたWHERE条件は、あえて記述しておく

## ■ JOIN, LEFT OUTER JOIN
- 結合キーはこれでもかというくらい確認する
- モニタリング向けの独自マスタは必ず外部結合に
- ３回以上登場するサブクエリはWITH句に
- 母数の絞込み目的のINNER JOINは、わかりやすい別名に

## ■ GROUP BY
-

## ■ HAVING
-

## ■ ORDER BY
- レコード数に気をつけよう
